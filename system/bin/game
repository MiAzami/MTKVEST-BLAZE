#!/bin/sh

# Enable CPUs
for cpu in /sys/devices/system/cpu/cpu[0-7]; do
    echo 1 > "$cpu/online"
done

# Set CPU frequency governors to performance mode
for policy in /sys/devices/system/cpu/cpufreq/policy*; do
    chmod 644 "$policy/scaling_governor"
    echo "performance" > "$policy/scaling_governor"
done

# Set device frequency governors to performance mode
for device in /sys/class/devfreq/*; do
    if [ -f "$device/governor" ]; then
        chmod 644 "$device/governor"
        echo "performance" > "$device/governor"
    fi
done

# GPU frequency settings
if [ -d /proc/gpufreq ]; then
    gpu_freq=$(grep -o 'freq = [0-9]*' /proc/gpufreq/gpufreq_opp_dump | sed 's/freq = //' | sort -nr | head -n 1)
    apply "$gpu_freq" /proc/gpufreq/gpufreq_opp_freq
elif [ -d /proc/gpufreqv2 ]; then
    apply 00 /proc/gpufreqv2/fix_target_opp_index
fi

# Additional GPU settings
echo "coarse_demand" > /sys/class/misc/mali0/device/power_policy

echo 2 0 > /proc/ppm/policy_status  # Disable FORCE_LIMIT
echo 3 0 > /proc/ppm/policy_status  # Disable PWR_THRO
echo 4 0 > /proc/ppm/policy_status  # Disable THERMAL
echo 7 0 > /proc/ppm/policy_status  # Disable USER_LIMIT
echo 9 1 > /proc/ppm/policy_status  # Enable SYS_BOOST

# GPU frequency limit table
if [ -f "/proc/gpufreq/gpufreq_limit_table" ]; then
    for setting in ignore_batt_oc ignore_batt_percent ignore_batt_low ignore_thermal ignore_pbm; do
        echo "$setting 1" >> /proc/gpufreq/gpufreq_limit_table
    done
fi

# Disable Energy Aware Scheduling (EAS) and set various CPU freq settings
echo 0 > /sys/devices/system/cpu/eas/enable
echo 3 > /proc/cpufreq/cpufreq_power_mode
echo 1 > /proc/cpufreq/cpufreq_cci_mode
echo 1 > /proc/cpufreq/cpufreq_sched_disable
echo 0 > /proc/gpufreq/gpufreq_power_limited

# CPUSET configuration
for cs in /dev/cpuset
do
    echo 0-7 > "$cs/cpus"
    echo 0-6 > "$cs/background/cpus"
    echo 0-3 > "$cs/system-background/cpus"
    echo 0-7 > "$cs/foreground/cpus"
    echo 0-7 > "$cs/top-app/cpus"
    echo 0-5 > "$cs/restricted/cpus"
    echo 0-7 > "$cs/camera-daemon/cpus"
    echo 1 > "$cs/memory_pressure_enabled"
    echo 0 > "$cs/sched_load_balance"
    echo 1 > "$cs/foreground/sched_load_balance"
done

# Disallow power saving mode for display
for dlp in /proc/displowpower
do
    echo 1 > "$dlp/hrt_lp"
    echo 1 > "$dlp/idlevfp"
    echo 100 > "$dlp/idletime"
done

echo 100 > /dev/cpuctl/foreground/cpu.uclamp.min
echo 100 > /dev/cpuctl/top-app/cpu.uclamp.min
echo 100 > /dev/cpuctl/pnpmgr_fg/cpu.uclamp.min

# Scheduler settings
echo 500000 > /proc/sys/kernel/sched_migration_cost_ns
echo 5 > /proc/sys/kernel/perf_cpu_time_max_percent
echo 10000000 > /proc/sys/kernel/sched_latency_ns
echo 1024 > /proc/sys/kernel/sched_util_clamp_max
echo 1024 > /proc/sys/kernel/sched_util_clamp_min
echo 2 > /proc/sys/kernel/sched_tunable_scaling
echo 1 > /proc/sys/kernel/sched_child_runs_first
echo 0 > /proc/sys/kernel/sched_energy_aware
echo 1024 > /proc/sys/kernel/sched_util_clamp_min_rt_default
echo 200 > /proc/sys/kernel/sched_deadline_period_max_us
echo 100 > /proc/sys/kernel/sched_deadline_period_min_us
echo 0 > /proc/sys/kernel/sched_schedstats
echo 3000000 > /proc/sys/kernel/sched_wakeup_granularity_ns
echo 1000000 > /proc/sys/kernel/sched_min_granularity_ns

# Block device settings
for device in /sys/block
do
    [ -d "$device/queue" ] || continue
    echo 0 > "$device/queue/add_random"
    echo 0 > "$device/queue/iostats"
    echo 2 > "$device/queue/nomerges"
    echo 2 > "$device/queue/rq_affinity"
    echo 128 > "$device/queue/nr_requests"
    echo 2048 > "$device/queue/read_ahead_kb"
    [ "$(cat "$device/queue/rotational")" -eq 0 ] && echo 0 > "$device/queue/rotational"
done

# Power level settings
for pl in /sys/devices/system/cpu/perf
do
    echo 1 > "$pl/gpu_pmu_enable"
    echo 1 > "$pl/fuel_gauge_enable"
    echo 1 > "$pl/enable"
    echo 1 > "$pl/charger_enable"
done

# Virtual memory settings
echo 4 > /proc/sys/vm/dirty_background_ratio
echo 15 > /proc/sys/vm/dirty_ratio
echo 180 > /proc/sys/vm/vfs_cache_pressure
echo 3000 > /proc/sys/vm/dirty_expire_centisecs
echo 5000 > /proc/sys/vm/dirty_writeback_centisecs
echo 0 > /proc/sys/vm/oom_dump_tasks
echo 3 > /proc/sys/vm/page-cluster
echo 0 > /proc/sys/vm/block_dump
echo 10 > /proc/sys/vm/stat_interval
echo 0 > /proc/sys/vm/compaction_proactiveness
echo 1 > /proc/sys/vm/watermark_boost_factor
echo 3 > /proc/sys/vm/drop_caches
echo 10 > /proc/sys/vm/swappiness

for path in /dev/stune/*; do
    base=$(basename "$path")
    
    if [[ "$base" == "top-app" || "$base" == "foreground" ]]; then
        echo 40 > "$path/schedtune.boost"
        echo 1 > "$path/schedtune.sched_boost_enabled"
    else
        echo 10 > "$path/schedtune.boost"
        echo 0 > "$path/schedtune.sched_boost_enabled"
    fi
    
    echo 0 > "$path/schedtune.prefer_idle"
    echo 0 > "$path/schedtune.colocate"
done

